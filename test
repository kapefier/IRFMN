import csv
import os
import pandas as pd
import matplotlib.pyplot as plt

def filter_data(csv_path, uid_path, output_csv, valore_threshold=38, datastart_threshold=1440):
    
    df = pd.read_csv(csv_path)
    uids = pd.read_csv(uid_path, usecols=[1])
    
   
    t38in24_uids = df[(df['VALORE'] >= valore_threshold) & (df['DATASTART'] < datastart_threshold)]['UID'].tolist()
    uids['t38in24h'] = uids.UID.map(lambda x: x in t38in24_uids)
    
     
    uids_sorted = uids.sort_values(by='UID')
    
    # Print the results
    total_uids = uids.shape[0]
    total_true = uids['t38in24h'].sum()
    percentage_true = (total_true / total_uids) * 100
    
    print(f"N of pts with temp recorded: {total_uids}")
    print(f"Early hyperthermia (temp >= {valore_threshold} Â°C within the first {datastart_threshold} minutes)")
    print(f"N of pts: {total_true} ")
    print(f"Percentage of pts: {percentage_true:.2f}%")
    
    # Save the sorted DataFrame to a CSV file
    uids_sorted.to_csv(output_csv, index=False)
    
    # Set Plot
    labels = ['True', 'False']
    sizes = [total_true, total_uids - total_true]
    colors = ['red', 'lightgreen']
    explode = (0.1, 0)
    
    # Plot
    plt.figure(figsize=(8, 8))
    plt.pie(sizes, explode=explode, labels=labels, colors=colors, autopct='%1.1f%%', shadow=True, startangle=140)
    plt.title('Early Hypertermia')
    plt.show()

# Example usage
filter_data("../params/01_Temperatura.csv", "../UID.csv", "filteredtemp.csv", valore_threshold=38, datastart_threshold=1440)
